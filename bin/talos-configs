#!/usr/bin/env bash
set -eEuo pipefail
test -z "${DEBUG:-}" || set -x
test -n "${PRJ_ROOT:-}" || eval "$(cd "${BASH_SOURCE[0]%/*}" && direnv export bash)"

handle_file() {
  local filename="$1"
  echo "$filename"
}

find_configs() {
  find_files "${PRJ_ROOT}/patches" yaml "$@"
  find_files "${PRJ_ROOT}/state" yaml "$@"
}

find_files() {
  local base_dir="$1" extension="$2" filenames=() args=() search_names=()
  shift 2

  for arg in "$@"; do
    if test "${#args[@]}" == 0 && test "x$arg" == "x--"; then
      args=("${filenames[@]}")
      filenames=()
    else
      filenames+=("$arg")
    fi
  done

  for filename in "${filenames[@]}"; do
    search_names=()
    for file in "${base_dir}/${filename}" "${base_dir}/${filename}.d"; do
      test -e "${file}" || continue
      search_names+=("${file}")
    done
    test "${#search_names[@]}" -eq 0 || find "${search_names[@]}" \
      -maxdepth 1 \
      -not '(' -type d ')' \
      -name "*.${extension}" \
      "${args[@]}"
  done
}

main() {
  find_configs "$@" -print0 | while IFS= read -r -d '' filename; do
    handle_file "$filename"
  done
}

main "$@"
